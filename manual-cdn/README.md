# Manual Domain Creation

In the event the broker is unavailable, custom domains can be created manually using the process below. The process requires coordination of a DNS entry as well as two DNS challenges. The overall process involves:

1. **Generating Certificates**: *This requires real time coordination to set up DNS challenges. It can be done by ops or the customer.*
1. **Importing Certs into ACM**
1. **Creating the CloudFront Distribtuion**

A script is included which automates this process (`create-distribution.sh`). The script uses certbot and terraform.

## Prerequisites

Be sure you have the following prereqs completed before continuing.

### Installing Certbot

Certificates are generated by [Let's Encrypt](https://letsencrypt.org/) via the [certbot](https://certbot.eff.org/) command line interface (CLI). You can install certbot on MacOS using homebrew:

* `brew install letsencrypt`

or via the [instructions](https://certbot.eff.org/docs/install.html).

### Terraform

Be sure you have the terraform client installed (`brew upgrade terraform` is a good idea), you have cloned this repo, and have run `terraform init` in this directory. 

### Run aws configure

Be sure you run `aws configure` and provide credentials for AWS Commercial Production. Be sure to use `us-east-1` as the region as ACM support for terraform only works in `us-east-1`.

### Setup a base directory

The `create-distribution.sh` script requires a local directory in which certificates and terraform variables will be stored. This is referenced in the script instructions as `base-directory`. Be sure you have such a directory created, perhaps as `~/cdn` or similar.

### Gather the CDN Details

You will need to know:

- `domain`: The custom domain you are creating certificates and the CDN for (example: cloud.example.com).
- `contact-email`: The email address shared with Let's Encrypt for the domain (example: operator@cloud.gov). This can be your email.
- `base-directory`: Path to the base directory described above (example: ~/).
- `origin-domain`: The domain cloudfront will use at the origin. This is frequently a Federalist site (and will be provided by the Federalist team) or an app on the `app.cloud.gov` domain.
- `origin-path` (optional): The path cloudfront will access on the origin-domain to fetch content (frequently provided by federalist team). If the origin is an `app.cloud.gov` app, there may not be an origin-path.

## Creating a new CDN

Certificate generation requires real-time coordination with the customer's DNS admin. DNS challenges must be configured and verified in order to proceed. 

Run the `create-distribution.sh` script with the above inputs.  The script will do the following:

- Set up the correct directories for each domain in `$base-directory`.
- Run certbot
- Generate a `*.tfvars` file in `$base-directory/$domain`
- Run terraform apply

### Accepting Terms

Using certbot requires accepting a few terms, namely:

- terms of service
- contact-email will be shared with eff.org
- your ip address will be logged

The certbot command executed in the `create-distribution.sh` script will accept the terms of service and agree to share the contact email. However, you will be prompted with the question "Are you OK with your IP being logged?" to which you must enter "Y" to continue.

### DNS TXT Challenge

Certbot will prompt you to create a DNS TXT entry. The customer DNS admin will need to set up this record. The name is of the form `_acme-challenge.$domain`. Note the leading underscore is required. The value is generated by certbot. 

This record must exist before you continue otherwise the creation process will fail. If the process fails, a new TXT value will be created and will need to be configured. You can check that this record has been created and propagated in another terminal window via:

```
nslookup -type=txt _acme-challenge.$domain
```

When the TXT entry is verified, press Enter to continue. Certbot will generate certificates in `$base_directory/$domain/config/live/$domain`. Note you will have the ONLY copy of the private key at this point. Treat your `$base_directory` accordingly.

### Terraform

The script will then run terraform. You will be able to review the plan and must type 'yes' to apply the changes.

### CNAME creation

The last step is to have the customer DNS admin create a CNAME record mapping the `$domain` to the Cloudfront distribution URL. Terraform will run for a bit of time (usually at least 30 minutes) while the Cloudfront distribution is being created. You can either wait for this to finish and spit out the URL, or to speed up the procees you can fetch the necessary value from the AWS console. 

- Log into the AWS console > CloudFront > search for the distribution by `$domain`. The CNAME value will be displayed in the `Domain Name` column.

Once the distribution is created and the CNAME entry is verified (`nslookup $domain`), you should be able to access the site in a browser via `$domain`.

## Troubleshooting

Sometimes Cloudfront can do strange things depending on the status of the origin when it tries to fetch content. 

### Redirecting to the Origin

If you try to access `$domain` in a browswer and are redirected to the origin, Cloudfront has inadvertantly cached a `301` redirect. The easiest fix is to create an invalidation to clear out the cache.

In the AWS console, go to CloudFront > the distribution (search by domain) > Invalidations. Click `Create Invalidation` and enter `*` in the `Object Paths` field. Then click `Invalidate`. 

Wait for the invalidation to complete then access `$domain` again. You need to be sure your browser isn't caching also (CMD+SHIFT+R in chrome).

## Deleting 

You can delete the certificates from AWS and the Cloudfront distribution using terraform. You need to supply the path to the `.tfvars` file the script created (located in `$base-directory/$domain/$domain.tfvars)

```
terraform destroy --vars-file <base-directory/domain/domain>.tfvars
```
