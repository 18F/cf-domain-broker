# Manual Domain Creation

In the event the broker is unavailable, custom domains can be created manually using the process below. The process requires coordination of a DNS entry as well as a DNS challenge. The overall process involves:

1. **Generating certificates**: *This requires real time coordination to set up DNS challenges. It can be done by ops or the customer.*
1. **Importing certificates into IAM**
1. **Adding the certificate to the load balancer**

A script is included which automates this process (`create-domain.sh`). The script uses certbot and terraform.

## Prerequisites

Be sure you have the following prereqs completed before continuing.

### Installing Certbot

Certificates are generated by [Let's Encrypt](https://letsencrypt.org/) via the [certbot](https://certbot.eff.org/) command line interface (CLI). You can install certbot on MacOS using homebrew:

* `brew install letsencrypt`

or via the [instructions](https://certbot.eff.org/docs/install.html).

### Terraform

Be sure you have the terraform client installed (`brew upgrade terraform` is a good idea), you have cloned this repo, and have run `terraform init` in this directory. 

### Run aws configure

Be sure you run `aws configure` and provide credentials for **AWS GovCloud Production**. Be sure to use `us-gov-west-1` as the region.

### Setup a base directory

The `create-domain.sh` script requires a local directory in which certificates and terraform variables will be stored. This is referenced in the script instructions as `base-directory`. Be sure you have such a directory created, perhaps as `~/domains` or similar.

### Gather the domain details

You will need to know:

- `domain`: The custom domain you are creating certificates for (example: cloud.example.com).
- `contact-email`: The email address shared with Let's Encrypt for the domain (example: operator@cloud.gov). This can be your email.
- `base-directory`: Path to the base directory described above (example: ~/domains).
- `listener-arn`: The ARN of the HTTPS listener on which to configure certificates. Details on how to select this are below.

#### Listener ARN

Creating a custom domain without CDN (Cloud Front) is different in that you have to configure the certificates on a specific load balancer. Normally the broker selects this, but you will need to do so before running the script. To select a load balancer:

- Log in to AWS Prod GovCloud > EC2 > Load Balancers
- Filter by `production-domains`
- Select one of the production domain load balancers with the name `production-domains-#`. Do not select the `production-domains-internal`
- Make a note of the `DNS name` on the description tab. You will need this later.
- Select the listener tab
- Select the HTTPS listener and click edit
- Copy the ARN 

## Creating a new domain

Certificate generation requires real-time coordination with the customer's DNS admin. DNS challenges must be configured and verified in order to proceed. 

Run the `create-domain.sh` script with the above inputs.  The script will do the following:

- Set up the correct directories for each domain in `$base-directory`.
- Run certbot
- Generate a *.tfvars file in `$base-directory/$domain`
- Run terraform apply

### Accepting Terms

Using certbot requires accepting a few terms, namely:

- terms of service
- contact-email will be shared with eff.org
- your ip address will be logged

The certbot command executed in the `create-domain.sh` script will accept the terms of service and agree to share the contact email. However, you will be prompted with the question "Are you OK with your IP being logged?" to which you must enter "Y" to continue.

### DNS TXT Challenge

Certbot will prompt you to create a DNS TXT entry. The customer DNS admin will need to set up this record. The name is of the form `_acme-challenge.$domain`. Note the leading underscore is required. The value is generated by certbot. 

This record must exist before you continue otherwise the creation process will fail. If the process fails, a new TXT value will be created and will need to be configured. You can check that this record has been created and propagated in another terminal window via:

```
nslookup -type=txt _acme-challenge.$domain
```

When the TXT entry is verified, press Enter to continue. Certbot will generate certificates in `$base_directory/$domain/config/live/$domain`. Note you will have the ONLY copy of the private key at this point. Treat your `$base_directory` accordingly.

### Terraform

The script will then run terraform. You will be able to review the plan and must type 'yes' to apply the changes.

### A and AAAA records creation

The last step is to have the customer DNS admin create A and AAAA records mapping the IPs of the load balancer `DNS name` you noted above. 

- Set A records for the IPs of the load balancer `DNS name` noted above. You can see these via `nslookup <DNS_NAME>`.
- Set AAAA records for the IPs of the load balancer `DNS name` noted above. You can see these via `nslookup -type=AAAA <DNS_NAME>`.

Once the records propogate, the application should be available on the custom domain.

## Deleting 

You can delete the certificates from AWS and the Cloudfront distribution using terraform. You need to supply the path to the `.tfvars` file the script created (located in `$base-directory/$domain/$domain.tfvars)

```
terraform destroy --vars-file <base-directory/domain/domain>.tfvars
```